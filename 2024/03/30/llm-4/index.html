<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Julian">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://higiraffe.github.io/2024/03/30/llm-4/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta property="og:type" content="article">
<meta property="og:title" content="ã€å­¦ä¹ ç¬”è®°ã€‘vLLM">
<meta property="og:url" content="https://higiraffe.github.io/2024/03/30/llm-4/index.html">
<meta property="og:site_name" content="HiGiraffe">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/5">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/6">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/3">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/4">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/1">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/2">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/1.gif">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/7">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/2.gif">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/3.gif">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/8">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/9">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/10">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/11">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/12">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/13">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/14">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/15">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/16">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/17">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/18">
<meta property="og:image" content="https://higiraffe.github.io/images/llm-4/19">
<meta property="article:published_time" content="2024-03-30T11:35:07.000Z">
<meta property="article:modified_time" content="2024-04-18T16:07:24.765Z">
<meta property="article:author" content="Julian">
<meta property="article:tag" content="Artificial Intelligence">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://higiraffe.github.io/images/llm-4/5">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
    <meta name="theme-color" content="#1890ff">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            ã€å­¦ä¹ ç¬”è®°ã€‘vLLM -
        
        HiGiraffe
    </title>
    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
        <link href="home_banner.custom_font.url" rel="stylesheet">
    
    
    
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    
        <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    

    <!--- Inject Part-->
    
        
            
    
            
    
            
                
                    <style>.navbar-container .navbar-content .right .desktop .navbar-list .navbar-item, .navbar-container .navbar-content .right .desktop .navbar-list .navbar-item a i, .navbar-container .navbar-content .left .logo-title h1, .navbar-container .navbar-content .right .desktop .navbar-list .navbar-item.search i { color: #808080 !important; } </style>
                
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"higiraffe.github.io","root":"/","language":"en","path":"search.xml"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":false,"lazyload":true,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#1890ff","secondary":null},"global":{"fonts":{"chinese":{"enable":true,"family":"Noto Sans SC","url":"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"},"english":{"enable":true,"family":"Inter","url":"https://fonts.googleapis.com/css2?family=Inter&display=swap"}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":false,"site_pv":false,"site_uv":false,"post_pv":false},"single_page":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/qixingyan.jpg","dark":"/images/qixingyan.jpg"},"title":"A sutdent's learning journey","subtitle":{"text":["... and occasional confusion"],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#d9d9d9","dark":"#bcbcbc"},"text_style":{"title_size":"3rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":true,"family":"Noto Sans SC","url":"home_banner.custom_font.url"},"social_links":{"enable":true,"links":{"github":"https://github.com/hiGiraffe","instagram":null,"zhihu":null,"twitter":null,"email":"hiGiraffe@foxmail.com"},"qrs":null}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.4.4","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Resources":{"icon":"fa-regular fa-link","path":"/resources/"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Github":"https://github.com/hiGiraffe"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":3,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":"That's great! Just remember, if your study notes start talking back to you, it might be time for a break!","links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":1}},"footerStart":"2023/10/1 0:0:0"};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="swup-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="https://higiraffe.github.io/">
                
                HiGiraffe
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        ARCHIVES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/resources/"  >
                                    
                                        
                                            <i class="fa-regular fa-link"></i>
                                        
                                        RESOURCES
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        ABOUT&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a href="/about">ME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/hiGiraffe">GITHUB
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer w-full absolute top-0 left-0 bg-background-color">
        <ul class="drawer-navbar-list flex flex-col justify-start items-center">
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                ARCHIVES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group " 
                        href="/resources/"  >
                             
                                
                                    <i class="fa-regular fa-link"></i>
                                
                                RESOURCES
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item text-base my-1.5 flex justify-center items-center">
                        <a class="rounded-3xl py-1.5 px-5 hover:border hover:!text-primary active:!text-primary group has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                ABOUT&nbsp;<i class="group-hover:rotate-180 transition-transform fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" href="/about">ME</a>
                            </li>
                        
                            <li class="text-base flex justify-center items-center hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                <a class="py-0.5" target="_blank" rel="noopener" href="https://github.com/hiGiraffe">GITHUB</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container">
    <div class="article-content-container">

        <div class="article-title">
            
                <h1 class="article-title-regular">ã€å­¦ä¹ ç¬”è®°ã€‘vLLM</h1>
            
            </div>
            
                    
        
        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://avatars.githubusercontent.com/u/146565245?v=4">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Julian</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-03-30 19:35:07</span>
        <span class="mobile">2024-03-30 19:35:07</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-04-19 00:07:24</span>
            <span class="mobile">2024-04-19 00:07:24</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/AI/">AI</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/AI/LLM/">LLM</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Artificial-Intelligence/">Artificial Intelligence</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body">
            <a class="button  center regular" target="_blank" rel="noopener" href="https://arxiv.org/abs/2309.06180" title="vLLM arxivè®ºæ–‡"><i class="fa-solid fa-paperclip"></i> vLLM arxivè®ºæ–‡</a>

<a class="button  center regular" target="_blank" rel="noopener" href="https://blog.vllm.ai/2023/06/20/vllm.html" title="vLLMå…³äºPagedAttentionçš„åšå®¢"><i class="fa-solid fa-paperclip"></i> vLLMå…³äºPagedAttentionçš„åšå®¢</a>

<a class="button  center regular" target="_blank" rel="noopener" href="https://docs.vllm.ai/en/latest/" title="vLLMå®˜æ–¹æ–‡æ¡£"><i class="fa-solid fa-paperclip"></i> vLLMå®˜æ–¹æ–‡æ¡£</a>

<a class="button  center regular" target="_blank" rel="noopener" href="https://readpaper.feishu.cn/docx/EcZxdsf4uozCoixdU3NcW03snwV" title="å›½å†…åšå®¢"><i class="fa-solid fa-paperclip"></i> å›½å†…åšå®¢</a>



<h1 id="é¢„å¤‡çŸ¥è¯†"><a href="#é¢„å¤‡çŸ¥è¯†" class="headerlink" title="é¢„å¤‡çŸ¥è¯†"></a>é¢„å¤‡çŸ¥è¯†</h1><h2 id="transformerçš„self-attention-layers"><a href="#transformerçš„self-attention-layers" class="headerlink" title="transformerçš„self-attention layers"></a>transformerçš„self-attention layers</h2><blockquote>
<p>For an input hidden state sequence <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.575ex" height="2.497ex" role="img" focusable="false" viewBox="0 -853.7 8652 1103.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(389,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(961,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1461,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(1905.7,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(2350.3,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(2795,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(3239.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(3684.3,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mi" transform="translate(4256.3,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(4856.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(5523.1,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path></g><g data-mml-node="msup" transform="translate(6467.9,0)"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(792,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(600,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(1378,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></g></g></svg></mjx-container> , a self-attention layer first applies linear transformations on each position ğ‘– to get the query, key, and value vectors:</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/5" alt="image-20240331111833960"></p>
<p>Then, the self-attention layer computes the attention score <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="2.596ex" height="1.663ex" role="img" focusable="false" viewBox="0 -441 1147.3 735.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="TeXAtom" transform="translate(562,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(345,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path></g></g></g></g></g></svg></mjx-container> by multiplying the query vector at one position with all the key vectors before it and compute the output <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="1.837ex" height="1.355ex" role="img" focusable="false" viewBox="0 -441 812 598.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container> as the weighted average over the value vectors:</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/6" alt="image-20240331111955260"></p>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå…ˆæŠŠæ¯ä¸ªä½ç½®çš„è¯ç®—å‡ºå…¶q k vï¼Œç„¶åç”¨æ³¨æ„åŠ›å…¬å¼ç®—å‡ºæ¯ä¸¤ä¸ªè¯ä¹‹é—´çš„aå’Œæ¯ä¸ªè¯çš„oã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œtransformer including the embedding layer, feed-forward layer, layer normalization, residual connection, output logit computation, and the query, key, and value transformation.</p>
<h2 id="KV-Cache"><a href="#KV-Cache" class="headerlink" title="KV Cache"></a>KV Cache</h2><blockquote>
<p>ä»¥GPTä¸ºä»£è¡¨çš„Decoder-Onlyè‡ªå›å½’è¯­è¨€æ¨¡å‹åœ¨ç”Ÿæˆæ¯ä¸€ä¸ªæ–°çš„ token æ—¶ï¼Œæ¥å—æ‰€æœ‰ä¹‹å‰ç”Ÿæˆçš„ tokens ä½œä¸ºè¾“å…¥ã€‚ç„¶è€Œï¼Œå¯¹äºè¿™äº›å…ˆå‰ç”Ÿæˆçš„ tokensï¼Œæ¯æ¬¡ç”Ÿæˆæ–°çš„ token æ—¶éƒ½éœ€è¦é‡æ–°è®¡ç®—ä»–ä»¬çš„è¡¨ç¤ºï¼Œè¿™ä¸ªè¿‡ç¨‹é€ æˆäº†å¤§é‡çš„è®¡ç®—æµªè´¹ã€‚KV Cache çš„å¼•å…¥å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>KV Cacheå®è´¨ä¸Šæ˜¯å­˜å‚¨äº†ä¹‹å‰è®¡ç®—è¿‡çš„ key-value å¯¹ç”¨äºä¸‹ä¸€ä¸ªTokençš„ç”Ÿæˆã€‚åœ¨ Transformer ç»“æ„ä¸­ï¼Œself-attention ä¸­çš„k_proj, v_projä¼šå°†è¾“å…¥çš„æ¯ä¸ª token è½¬åŒ–ä¸ºä¸€ä¸ª key å’Œä¸€ä¸ª valueï¼Œç„¶åä½¿ç”¨è¿™äº› key-value ä»¥åŠå½“å‰çš„queryå¯¹æ¥è®¡ç®—ä¸‹ä¸€ä¸ª tokenã€‚å¼•å…¥ KV Cacheï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¹‹å‰ç”Ÿæˆçš„ tokens å¯¹åº”çš„ key-value å¯¹å­˜å‚¨èµ·æ¥ï¼Œå½“ç”Ÿæˆæ–°çš„ token æ—¶ï¼Œ<strong>ç›´æ¥ä» KV Cache ä¸­å–å‡ºè¿™äº›å·²ç»è®¡ç®—å¥½çš„ key-value å¯¹ï¼Œå†æŠŠå½“å‰tokençš„key-valueåšä¸€ä¸ªè¿ç»“åœ¨è¿›è¡Œè®¡ç®—</strong>ï¼Œè¿™æ ·å°±é¿å…äº†KVçš„é‡å¤è®¡ç®—ï¼Œå¤§å¤§æé«˜äº†è®¡ç®—æ•ˆç‡ã€‚</p>
</blockquote>
<p>KV CacheåŒ…å«ä»¥ä¸‹æ­¥éª¤</p>
<blockquote>
<p><strong>é¢„å¡«å……é˜¶æ®µ</strong>ï¼šåœ¨è®¡ç®—ç¬¬ä¸€ä¸ªè¾“å‡ºtokenè¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶Cacheæ˜¯ç©ºçš„ï¼Œè®¡ç®—æ—¶éœ€è¦ä¸ºæ¯ä¸ª transformer layer è®¡ç®—å¹¶ä¿å­˜key cacheå’Œvalue cacheï¼Œåœ¨è¾“å‡ºtokenæ—¶Cacheå®Œæˆå¡«å……ï¼›FLOPsåŒKV Cacheå…³é—­ä¸€è‡´ï¼Œå­˜åœ¨å¤§é‡gemmæ“ä½œï¼Œæ¨ç†é€Ÿåº¦æ…¢ï¼Œè¿™æ—¶å±äºCompute-boundç±»å‹è®¡ç®—ã€‚</p>
<p><strong>KV Cacheé˜¶æ®µ</strong>ï¼šåœ¨è®¡ç®—ç¬¬äºŒä¸ªè¾“å‡ºtokenè‡³æœ€åä¸€ä¸ªtokenè¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶Cacheæ˜¯æœ‰å€¼çš„ï¼Œæ¯è½®æ¨ç†åªéœ€è¯»å–Cacheï¼ŒåŒæ—¶å°†å½“å‰è½®è®¡ç®—å‡ºçš„æ–°çš„Keyã€Valueè¿½åŠ å†™å…¥è‡³Cacheï¼›FLOPsé™ä½ï¼Œgemmå˜ä¸ºgemvæ“ä½œï¼Œæ¨ç†é€Ÿåº¦ç›¸å¯¹ç¬¬ä¸€é˜¶æ®µå˜å¿«ï¼Œè¿™æ—¶å±äºMemory-boundç±»å‹è®¡ç®—ã€‚</p>
</blockquote>
<blockquote>
<p>æ— KV Cacheç”Ÿæˆç¤ºä¾‹</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/3" alt="image-20240330213245722"></p>
</blockquote>
<blockquote>
<p>KV Cacheç”Ÿæˆç¤ºä¾‹</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/4" alt="image-20240330213306988"></p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†KV CacheèŠ‚çœäº†å¤§é‡çš„é‡å¤è®¡ç®—ã€‚</p>
<h2 id="å½“å‰Batching-Techniques-for-LLMs"><a href="#å½“å‰Batching-Techniques-for-LLMs" class="headerlink" title="å½“å‰Batching Techniques for LLMs"></a>å½“å‰Batching Techniques for LLMs</h2><p>å›°å¢ƒï¼š</p>
<ul>
<li>è¯·æ±‚å¯èƒ½åœ¨ä¸åŒæ—¶é—´æ®µåˆ°è¾¾</li>
<li>è¯·æ±‚åºåˆ—çš„é•¿åº¦ä¸åŒ</li>
</ul>
<p>ç›®å‰æ–¹æ³•ï¼š</p>
<ul>
<li>é‡‡ç”¨ç»†ç²’åº¦çš„æ‰¹å¤„ç†æœºåˆ¶</li>
</ul>
<h2 id="Memory-Challenges-in-LLM-Serving"><a href="#Memory-Challenges-in-LLM-Serving" class="headerlink" title="Memory Challenges in LLM Serving"></a>Memory Challenges in LLM Serving</h2><p>æŒ‘æˆ˜ï¼š</p>
<ul>
<li>KV cacheå¤ªå¤§äº†ï¼Œä¸”GPUçš„è®¡ç®—èƒ½åŠ›ä¼šæ¯”å…¶å†…å­˜å¢é•¿å¾—æ›´å¿«ã€‚</li>
<li>decodingç®—æ³•è¶Šæ¥è¶Šå¤æ‚ï¼Œå¦‚ä½•é€‚é…ã€‚</li>
<li>è¾“å…¥è¾“å‡ºé•¿åº¦ä¸åŒçš„æƒ…å†µä¸‹å¦‚ä½•è°ƒåº¦èµ„æºã€‚</li>
</ul>
<h1 id="vLLM"><a href="#vLLM" class="headerlink" title="vLLM"></a>vLLM</h1><h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><p><strong>æ•ˆæœ</strong>ï¼š</p>
<blockquote>
<p> PagedAttention, an attention algorithm inspired by the classical <strong>virtual memory</strong> and <strong>paging techniques</strong> in operating systems</p>
</blockquote>
<p>æƒ³æ³•æ¥æºäºè™šæ‹Ÿå†…å­˜å’Œåˆ†é¡µæŠ€æœ¯</p>
<blockquote>
<p>vLLM, an LLM serving system that achieves (1) <strong>near-zero waste</strong> in KV cache memory and (2) <strong>flexible sharing of KV cache</strong> within and across requests to further reduce memory usage.</p>
</blockquote>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/1" alt="image-20240330194543256"></p>
</blockquote>
<p>å·¦å›¾å°±æ˜¯vLLMå°†KV Cacheæ§åˆ¶åœ¨çº¢è‰²ï¼Œä¸”ç”¨ä¸€éƒ¨åˆ†é»„è‰²è¿›è¡Œæ¿€æ´»ã€‚æ‰€ä»¥éšç€è§„æ¨¡æ‰©å¤§ï¼ŒvLLMçš„å†…å­˜ä½¿ç”¨é‡å¯ä»¥æ§åˆ¶å¾—æ›´å¥½ã€‚æ­£å¦‚å³å›¾æ‰€ç¤ºã€‚</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/2" alt="image-20240330194852044"></p>
</blockquote>
<p>å†…å­˜èµ„æºæµªè´¹å¹³å‡ç™¾åˆ†æ¯”å›¾ï¼Œå¯ä»¥çœ‹åˆ°vLLMçš„æœ‰æ•ˆæ€§ã€‚</p>
<h2 id="PagedAttention"><a href="#PagedAttention" class="headerlink" title="PagedAttention"></a>PagedAttention</h2><p><strong>ç‰¹è‰²ï¼š</strong>å…è®¸ä¸è¿ç»­çš„KV cacheå­˜å‚¨æ–¹å¼ã€‚æ–¹æ³•æ˜¯é‡‡ç”¨åˆ†å—çš„æ–¹å¼ã€‚</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/1.gif" alt="annimation0"></p>
</blockquote>
<p>å½“åŸæ–‡ä¸º Alan Turing is a|computer scientist and mathmatician|renowned for â€¦</p>
<p>å…¶è¢«åˆ†æˆä¸‰ä¸ªå—æ¥å®Œæˆï¼Œè¿™ä¸‰ä¸ªå—çš„ç‰©ç†å†…å­˜ä¸ä¸€æ ·ã€‚</p>
<p>è®¡ç®—æ–¹å¼ä¸º</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/7" alt="image-20240331114636223"></p>
</blockquote>
<p>è¿™æ ·å°±å¯ä»¥å‡å°‘KV Cacheçš„æµªè´¹ï¼Œæœ€å¤šæµªè´¹3ä¸ªç©ºã€‚ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ“ä½œç³»ç»Ÿå¼•å…¥åˆ†é¡µæœºåˆ¶ï¼‰</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/2.gif" alt="fcc6f1bb-484e-43ab-8101-dc5dbbdbcd89"></p>
</blockquote>
<p>å¹¶ä¸”æ ¹æ®æ“ä½œç³»ç»Ÿçš„<strong>å†™æ—¶å…±äº«æœºåˆ¶</strong>ï¼ŒPagedAttention å¯ä»¥å½“äº§ç”Ÿå¤šä¸ªç»“æœæ—¶ï¼Œå°†ä¸‹å›¾ä¸­çš„intelligence iså¤åˆ¶åˆ°å¤šä¸ªå—ä¸Šã€‚</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/3.gif" alt="annimation3"></p>
</blockquote>
<p>è¿˜é‡‡ç”¨äº†<strong>æŸæœç´¢æœºåˆ¶</strong></p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/8" alt="image-20240331120042678"></p>
<p>è¿™æ˜¯ä¸€ä¸ªæŸå®½ä¸º2çš„<a class="link" target="_blank" rel="noopener" href="https://zh.d2l.ai/chapter_recurrent-modern/beam-search.html">æŸæœç´¢æ ·ä¾‹ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>ã€‚é€‰æ‹©æœ€å¤§çš„ä¸¤ä¸ªã€‚</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/9" alt="image-20240331120357189"></p>
<p>åœ¨vLLMä¸­ï¼Œåˆ™æ˜¯è¿™ç§æ•ˆæœï¼Œè·Ÿä¸Šå›¾éå¸¸ç›¸ä¼¼ã€‚</p>
</blockquote>
<p>vLLMä¹Ÿè€ƒè™‘åˆ°<strong>å…±äº«å‰ç¼€</strong>çš„é—®é¢˜ã€‚</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/10" alt="image-20240331120631554"></p>
</blockquote>
<p>å¯¹äºæ­¤ç±»åº”ç”¨vLLMä¼šå…±äº«å‰ç¼€ï¼Œåªåœ¨Task Inputä¸Šæœ‰å·®å¼‚ã€‚å…¶å®å°±æ˜¯å‰æ–‡çš„åˆ†é¡µæœºåˆ¶ã€‚</p>
<h2 id="Scheduling-and-Preemption"><a href="#Scheduling-and-Preemption" class="headerlink" title="Scheduling and Preemption"></a>Scheduling and Preemption</h2><p>é‡‡ç”¨<strong>first-come-first-serve</strong> (<strong>FCFS</strong>)ï¼Œå…ˆæ¥å…ˆæœåŠ¡ã€‚</p>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>å‡å¦‚æ»¡äº†ï¼Œåº”è¯¥é©±é€å“ªäº›å—<ul>
<li>transformerç‰¹æ€§â†’åŒä¸€ä¸ªåºåˆ—çš„å—è¦ä¹ˆä¸€èµ·è¢«é©±é€ï¼Œè¦ä¹ˆä¸€èµ·ç•™ä¸‹ã€‚</li>
<li>å‡å¦‚æœ‰æŸæœç´¢ï¼Œå…¶å°†åºåˆ—åˆ†æˆäº†å¾ˆå¤šç»„ï¼Œä¸”å­˜åœ¨å†…å­˜å…±äº«ï¼Œç»„å†…æ‰€æœ‰åºåˆ—çš„å—åŒæ—¶è¢«è°ƒåº¦ã€‚</li>
</ul>
</li>
<li>å‡å¦‚ä»è¢«éœ€è¦ï¼Œå¦‚ä½•æ¢å¤è¢«é©±é€çš„å—ã€‚<ul>
<li>äº¤æ¢ã€‚æ”¾åˆ°CPUå†…å­˜ä¸­ã€‚</li>
<li>é‡æ–°è®¡ç®—ã€‚å› ä¸ºè§£ç æ—¶çš„ä»¤ç‰Œå’Œç”¨æˆ·æç¤ºé“¾æ¥èµ·æ¥æˆä¸ºæ–°çš„æç¤ºï¼Œä¸€æ¬¡å°±å¯ä»¥ç”ŸæˆKV Cacheï¼Œæ‰€ä»¥ä¼šæ¯”ä¹‹å‰ç®—çš„å—ã€‚</li>
</ul>
</li>
</ul>
<h2 id="Distributed-Execution"><a href="#Distributed-Execution" class="headerlink" title="Distributed Execution"></a>Distributed Execution</h2><blockquote>
<p>Specifically, the attention operator is split on the attention head dimension, each SPMD process takes care of a subset of attention heads in multi-head attention.</p>
</blockquote>
<p>VLLMæ˜¯å°†æ³¨æ„åŠ›ç®—å­åœ¨æ³¨æ„åŠ›å¤´ç»´åº¦ä¸Šè¿›è¡Œåˆ†å‰²ã€‚</p>
<p>ä¸”ç”±äºæ¯ä¸ªæ¨¡å‹çš„åˆ†ç‰‡å¤„ç†ç›¸åŒçš„è¾“å…¥æ ‡è®°é›†ï¼Œæ‰€ä»¥vLLMé‡‡ç”¨çš„æ˜¯é›†ä¸­å¼è°ƒåº¦ï¼Œä¸€ä¸ªSchedulerã€‚</p>
<blockquote>
<p>This common mapping allows GPU workers to execute the model with the physical blocks provided by the scheduler for each input request. Although each GPU worker has the same physical block IDs, <strong>a worker only stores a portion of the KV cache for its corresponding attention heads.</strong></p>
</blockquote>
<p>ç”±äºå¤´ä¸åŒï¼Œç®¡ç†èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/11" alt="image-20240331122203810"></p>
<ol>
<li><p>In each step, the scheduler first prepares the message with input token IDs for each request in the batch, as well as the block table for each request. </p>
</li>
<li><p>Next, the scheduler broadcasts this control message to the GPU workers. </p>
</li>
<li><p>Then, the GPU workers start to execute the model with the input token IDs. </p>
</li>
<li><p>In the attention layers, the GPU workers read the KV cache according to the block table in the control message. </p>
</li>
<li><p>During execution, the GPU workers synchronize the intermediate results with the all-reduce communication primitive without the coordination of the scheduler, as in [47]. </p>
</li>
<li><p>In the end, the GPU workers send the sampled tokens of this iteration back to the scheduler.</p>
</li>
</ol>
</blockquote>
<h1 id="æºç è§£è¯»"><a href="#æºç è§£è¯»" class="headerlink" title="æºç è§£è¯»"></a>æºç è§£è¯»</h1><a class="button  center regular" target="_blank" rel="noopener" href="https://github.com/hiGiraffe/vllm" title="æºç ç¬”è®°"><i class="fa-solid fa-paperclip"></i> æºç ç¬”è®°</a>

<a class="button  center regular" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/691045737" title="å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼švLLMæºç è§£æ1ï¼Œæ•´ä½“æ¶æ„"><i class="fa-solid fa-paperclip"></i> å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼švLLMæºç è§£æ1ï¼Œæ•´ä½“æ¶æ„</a>

<a class="button  center regular" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/692540949" title="å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼švLLMæºç è§£æ2ï¼Œè°ƒåº¦å™¨ç­–ç•¥(Scheduler)"><i class="fa-solid fa-paperclip"></i> å›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼švLLMæºç è§£æ2ï¼Œè°ƒåº¦å™¨ç­–ç•¥(Scheduler)</a>

<blockquote>
<p>åœ¨vLLMä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ç¦»çº¿æ‰¹å¤„ç†æ¨¡å¼æ—¶ï¼Œè¡¨é¢ä¸Šæ˜¯åœ¨åšâ€œåŒæ­¥â€æ¨ç†ï¼Œä¹Ÿå³batch_sizeæ˜¯é™æ€å›ºå®šçš„ã€‚<strong>ä½†æ¨ç†å†…æ ¸å¼•æ“ï¼ˆLLMEngineï¼‰åœ¨å®é™…è¿ä½œæ—¶ï¼Œbatch_sizeæ˜¯å¯ä»¥åŠ¨æ€å˜æ›´çš„</strong>ï¼šåœ¨æ¯ä¸€ä¸ªæ¨ç†é˜¶æ®µï¼ˆ<strong>prefillç®—1ä¸ªæ¨ç†é˜¶æ®µï¼Œæ¯ä¸ªdecodeå„ç®—1ä¸ªæ¨ç†é˜¶æ®µ</strong>ï¼‰å¤„ç†çš„batch sizeå¯ä»¥æ ¹æ®å½“ä¸‹æ˜¾å­˜çš„å®é™…ä½¿ç”¨æƒ…å†µè€Œå˜åŠ¨ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼š</p>
<ul>
<li>ç»™å®šä¸€ä¸ªå¾ˆå¤§çš„batchï¼Œæ­¤æ—¶å°½ç®¡vLLMé‡‡ç”¨äº†PagedAttentionè¿™æ ·çš„æ˜¾å­˜ä¼˜åŒ–æŠ€æœ¯ï¼Œæˆ‘ä»¬çš„gpuä¾ç„¶æ— æ³•åŒæ—¶å¤„ç†è¿™ä¹ˆå¤§çš„batchã€‚</li>
<li>æ‰€ä»¥batchä¸­çš„æ¯ä¸€æ¡æ•°æ®ï¼Œä¼šè¢«å…ˆæ”¾åˆ°ä¸€ä¸ªwaitingé˜Ÿåˆ—ä¸­ã€‚vLLMä¼šç”¨è‡ªå·±çš„è°ƒåº¦ç­–ç•¥ä»waitingé˜Ÿåˆ—ä¸­ä¾æ¬¡å–æ•°ï¼ŒåŠ å…¥runningé˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°å®ƒè®¤ä¸ºå–å‡ºçš„è¿™äº›æ•°æ®å°†ä¼šæ‰“æ»¡å®ƒä¸º1ä¸ªæ¨ç†é˜¶æ®µåˆ†é…å¥½çš„æ˜¾å­˜ã€‚æ­¤æ—¶waitingé˜Ÿåˆ—ä¸­å¯èƒ½è¿˜ä¼šå‰©ä¸€äº›æ•°æ®ã€‚</li>
<li>åœ¨æ¯1ä¸ªæ¨ç†é˜¶æ®µï¼ŒvLLMå¯¹runningé˜Ÿåˆ—ä¸­çš„æ•°æ®åšæ¨ç†ã€‚å¦‚æœè¿™1ä¸ªæ¨ç†é˜¶æ®µæ‰§è¡Œå®Œæ¯•åï¼Œæœ‰çš„æ•°æ®å·²ç»å®Œæˆäº†ç”Ÿæˆï¼ˆæ¯”å¦‚æ­£å¸¸é‡åˆ°<code>&lt;eos&gt;</code>äº†ï¼‰ï¼Œå°±å°†è¿™äº›å®Œæˆçš„æ•°æ®ä»runningé˜Ÿåˆ—ä¸­ç§»å¼€ï¼Œå¹¶é‡Šæ”¾å®ƒå æ®çš„ç‰©ç†å—æ˜¾å­˜ã€‚</li>
<li>è¿™æ—¶ï¼Œwaitingé˜Ÿåˆ—ä¸­çš„æ•°æ®å°±å¯ä»¥ç»§ç»­appendè¿›runningé˜Ÿåˆ—ä¸­ï¼Œåšä¸‹1ä¸ªé˜¶æ®µçš„æ¨ç†ã€‚</li>
<li>å› æ­¤åœ¨æ¯1ä¸ªæ¨ç†é˜¶æ®µï¼ŒvLLMå¤„ç†çš„batch sizeå¯èƒ½ä¼šåŠ¨æ€å˜æ›´ã€‚</li>
<li>å°†LLMEngineåŒ…è£…æˆç¦»çº¿æ‰¹å¤„ç†å½¢å¼åï¼Œæ‰€æœ‰çš„æ•°æ®å¿…é¡»ç­‰åˆ°ä¸€èµ·åšå®Œæ¨ç†æ‰èƒ½è¿”ç»™æˆ‘ä»¬ã€‚æ‰€ä»¥ä»ä½“æ„Ÿä¸Šï¼Œæˆ‘ä»¬å¯èƒ½å¾ˆéš¾æ„ŸçŸ¥åˆ°å†…æ ¸å¼•æ“çš„â€œåŠ¨æ€â€é€»è¾‘ã€‚</li>
</ul>
<p><strong>åœ¨vLLMä¸­ï¼Œå³ä½¿æ˜¯åŒæ­¥å½¢å¼çš„ç¦»çº¿æ‰¹å¤„ç†ï¼Œå…¶èƒŒåçš„å†…æ ¸å¼•æ“ä¹Ÿæ˜¯æŒ‰åŠ¨æ€batchçš„å½¢å¼æ¥å®ç°çš„</strong></p>
<p><strong>æ­£æ˜¯å› ä¸ºLLMEngineè¿™ç§â€œåŠ¨æ€å¤„ç†â€çš„ç‰¹æ€§ï¼Œæ‰ä½¿å¾—å®ƒåŒæ—¶ä¹Ÿèƒ½æˆä¸ºå¼‚æ­¥åœ¨çº¿æœåŠ¡çš„å†…æ ¸å¼•æ“</strong>ï¼šå½“ä¸€æ¡æ¡è¯·æ±‚å‘æ¥æ—¶ï¼Œå®ƒä»¬éƒ½å…ˆè¿›å…¥LLMEngineè°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„waitingé˜Ÿåˆ—ä¸­ï¼ˆå®é™…å¹¶ä¸æ˜¯ç›´æ¥è¿›å…¥waitingé˜Ÿåˆ—ä¸­çš„ï¼Œè€Œæ˜¯åœ¨ä¼ ç»™LLMEngineå‰å…ˆè¿›å…¥asyncio.Queue()ä¸­ï¼Œç„¶åå†ç”±LLMEngineè°ƒåº¦è¿›waitingé˜Ÿåˆ—ä¸­çš„ï¼Œè¿™äº›ç»†èŠ‚æˆ‘ä»¬ä¹Ÿæ”¾åœ¨åé¢è¯´ï¼Œè¿™é‡Œä¸å½±å“ç†è§£å°±è¡Œï¼‰ã€‚æ­¤æ—¶æ¨¡å‹æ­£å¸¸æ‰§è¡Œå®ƒçš„1ä¸ªæ¨ç†é˜¶æ®µï¼Œè°ƒåº¦å™¨ä¹Ÿæ­£å¸¸å¤„ç†æ–°æ¥çš„è¯·æ±‚ã€‚å½“æ¨¡å‹å‡†å¤‡æ‰§è¡Œä¸‹1ä¸ªæ¨ç†é˜¶æ®µæ—¶ï¼Œè°ƒåº¦å™¨å†æ ¹æ®è®¾å®šçš„ç­–ç•¥ï¼Œå†³å®šå“ªäº›æ•°æ®å¯ä»¥è¿›å…¥runningé˜Ÿåˆ—è¿›è¡Œæ¨ç†ã€‚ç”±äºåœ¨çº¿æœåŠ¡æ˜¯å¼‚æ­¥çš„ï¼Œå…ˆæ¨ç†å®Œæˆçš„æ•°æ®å°±å¯ä»¥å…ˆå‘ç»™å®¢æˆ·ç«¯äº†ï¼ˆå¦‚æœé‡‡ç”¨æµå¼ä¼ è¾“ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆå¤šå°‘å…ˆå‘å¤šå°‘ï¼‰ã€‚<br><strong>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒvLLMé€šè¿‡PagedAttentionæŠ€æœ¯å’Œâ€œå…ˆæ¥å…ˆæœåŠ¡ï¼ˆFCFSï¼‰ï¼Œåæ¥å…ˆæŠ¢å ï¼Œgpuä¸å¤Ÿå°±å…ˆswapåˆ°cpuä¸Šâ€çš„è°ƒåº¦ç­–ç•¥ï¼Œåœ¨1ä¸ªæ¨ç†é˜¶æ®µå¤„ç†å°½å¯èƒ½å¤šçš„è¯·æ±‚ï¼Œè§£å†³é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ¨ç†ååé—®é¢˜ã€‚è¿™å°±æ˜¯æ•´ä¸ªvLLMè¿ä½œçš„æ ¸å¿ƒæ€æƒ³ã€‚ï¼ˆå¯¹è¿™è¡Œé»‘ä½“å­—é‡Œçš„æœ¯è¯­æœ‰ç–‘æƒ‘çš„æœ‹å‹ï¼Œå»ºè®®å…ˆçœ‹vLLMåŸç†ç¯‡è®²è§£ï¼‰</strong></p>
</blockquote>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/12" alt="img"></p>
</blockquote>
<blockquote>
<p>å…ˆæ¥çœ‹**<code>LLMEngine</code>**ï¼š</p>
<ul>
<li><strong><code>add_request()</code><strong>ï¼šè¯¥æ–¹æ³•å°†æ¯ä¸€ä¸ªè¯·æ±‚åŒ…è£…æˆvLLMèƒ½å¤„ç†çš„æ•°æ®ç±»å‹(SequenceGroupï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è§£é‡Š)ï¼Œå¹¶å°†å…¶åŠ å…¥è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„waitingé˜Ÿåˆ—ä¸­ã€‚</strong>åœ¨LLMEngineä¸­ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æŒ‰ç…§â€œåŒæ­¥â€çš„æ–¹å¼è®¾è®¡çš„</strong>ï¼Œä¹Ÿå°±æ˜¯å®ƒè¢«è®¾è®¡ä¸ºâ€œéå†batchä¸­çš„æ¯æ¡æ•°æ®ï¼Œç„¶ååšç›¸åº”å¤„ç†â€ã€‚æ‰€ä»¥è¿™ä¸ªå‡½æ•°æœ¬èº«åªé€‚åˆæ‰¹å¤„ç†åœºæ™¯ã€‚åœ¨å¼‚æ­¥çš„online servingä¸­å°†ä¼šæŠŠå®ƒé‡å†™æˆå¼‚æ­¥çš„å½¢å¼ã€‚</li>
<li>**<code>abort_request</code>**ï¼šåœ¨æ¨ç†è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„è¯·æ±‚éƒ½èƒ½æœ‰è¿”å›ç»“æœã€‚æ¯”å¦‚å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚çš„æ¨ç†å°±å¯ä»¥ç»ˆæ­¢äº†ï¼ˆabortï¼‰ï¼Œè¿™ä¸ªå‡½æ•°å°±è¢«ç”¨æ¥åšè¿™ä¸ªæ“ä½œã€‚</li>
<li><strong><code>step()</code>ï¼šè´Ÿè´£æ‰§è¡Œ1æ¬¡æ¨ç†è¿‡ç¨‹ï¼ˆ1ä¸ªprefillç®—1ä¸ªæ¬¡æ¨ç†ï¼Œæ¯ä¸ªdecodeå„ç®—1æ¬¡æ¨ç†ï¼‰</strong>ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼ŒvLLMçš„è°ƒåº¦å™¨ä¼šå†³å®šè¦é€é‚£äº›æ•°æ®å»æ‰§è¡Œæœ¬æ¬¡æ¨ç†ï¼Œå¹¶è´Ÿè´£ç»™è¿™äº›æ•°æ®åˆ†é…å¥½ç‰©ç†å—ï¼ˆè¿™äº›ä¿¡æ¯éƒ½è¢«ä½œä¸ºmetadataæ”¾åœ¨è¦é€ç»™æ¨¡å‹åšæ¨ç†çš„æ•°æ®ä¸­ï¼‰ã€‚æ¨¡å‹ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œé‡‡ç”¨PagedAttentionæ–¹æ³•ï¼Œå®é™…å®Œæˆæ¨ç†ã€‚</li>
</ul>
</blockquote>
<h2 id="æ•´ä½“ä»£ç æ¶æ„"><a href="#æ•´ä½“ä»£ç æ¶æ„" class="headerlink" title="æ•´ä½“ä»£ç æ¶æ„"></a>æ•´ä½“ä»£ç æ¶æ„</h2><blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/13" alt="img"></p>
<h3 id="Centralized-Controller"><a href="#Centralized-Controller" class="headerlink" title="Centralized Controller"></a>Centralized Controller</h3><p>**Centralized Controllerï¼Œä¹Ÿå°±æ˜¯å‰æ–‡æˆ‘ä»¬æ‰€è¯´çš„è°ƒåº¦å™¨(Scheduler)**ã€‚å®ƒå’ŒLLMEngineæ‰€åœ¨çš„è¿›ç¨‹æ˜¯åŒä¸€ä¸ªï¼Œä¸”ä¸¤è€…éƒ½æ˜¯åœ¨CPUä¸Šçš„ã€‚</p>
<ul>
<li><strong>è°ƒåº¦å™¨çš„ä¸»è¦ä½œç”¨å°±æ˜¯ï¼Œåœ¨æ¯1ä¸ªæ¨ç†é˜¶æ®µï¼Œå†³å®šè¦æŠŠå“ªäº›æ•°æ®é€ç»™æ¨¡å‹åšæ¨ç†ï¼ŒåŒæ—¶è´Ÿè´£ç»™è¿™äº›æ¨¡å‹åˆ†é…KV Cacheç‰©ç†å—</strong>ã€‚ä½†è¦æ³¨æ„ï¼Œå®ƒåªæ˜¯åˆ†é…äº†ç‰©ç†å—çš„idï¼Œè€Œä¸æ˜¯ç‰©ç†å—æœ¬èº«ã€‚ç‰©ç†å—çš„å®é™…åˆ†é…æ˜¯æ¨¡å‹åœ¨æ¨ç†è¿‡ç¨‹ä¸­æ ¹æ®ç‰©ç†å—idæ¥æ“ä½œçš„ï¼Œä¹Ÿå°±æ˜¯CacheEngineåšçš„äº‹æƒ…ã€‚</li>
<li><strong>è°ƒåº¦å™¨ä¸‹ç»´æŠ¤ç€BlockSpaceManagerã€‚å®ƒè´Ÿè´£ç®¡ç†BlockAllocatorï¼ˆå®é™…å‚ä¸åˆ†é…ç‰©ç†å—çš„ç±»ï¼‰ã€‚BlockAllocatoråˆåˆ†æˆgpuå’Œcpuä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«ç®¡ç†è¿™ä¸¤ç±»è®¾å¤‡ä¸Šçš„ç‰©ç†å—</strong>ã€‚<strong>ä½ å¯èƒ½ä¼šé—®ï¼Œcpuä¸Šçš„ç‰©ç†å—æ˜¯ä»€ä¹ˆå‘¢</strong>ï¼Ÿä½ è¿˜è®°å¾—è°ƒåº¦å™¨æœ‰ä¸€ä¸ªswapç­–ç•¥å—ï¼Ÿå½“gpuä¸Šæ˜¾å­˜ä¸è¶³æ—¶ï¼Œå®ƒä¼šæŠŠåæ¥çš„è¯·æ±‚æŠ¢å ï¼Œå¹¶å°†å…¶ç›¸å…³çš„KV cacheç‰©ç†å—å…¨éƒ¨éƒ½å…ˆswapï¼ˆç½®æ¢ã€å¸è½½ï¼‰åœ¨cpuä¸Šï¼Œç­‰åç»­gpuæ˜¾å­˜å……è¶³æ—¶ï¼Œå†æŠŠå®ƒä»¬åŠ è½½å›gpuä¸Šç»§ç»­åšç›¸å…³è¯·æ±‚çš„æ¨ç†ã€‚æ‰€ä»¥åœ¨cpuä¸Šæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªç®¡æ§ç‰©ç†å—çš„BlockAllocatorã€‚<strong>å®é™…ä»£ç å®ç°æ—¶ï¼ŒBlockç›¸å…³çš„éƒ¨åˆ†å¯ä¸æ­¢è¿™ä¸¤ä¸ªclassï¼Œè¿˜æœ‰ä¸€äº›æ›´å¤æ‚çš„é€»è¾‘ç»†èŠ‚ã€‚è¿™ä¸ªæˆ‘ä»¬æ”¾åœ¨æœ¬ç³»åˆ—åé¢çš„æ–‡ç« ä¸­è®²è§£</strong>ã€‚</li>
</ul>
<h3 id="Distributed-Workers"><a href="#Distributed-Workers" class="headerlink" title="Distributed Workers"></a>Distributed Workers</h3><p>Distributed Workersï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä½ å¯ä»¥å°†æ¯ä¸ªworkerç†è§£æˆä¸€å—gpuã€‚å®ƒçš„ä½œç”¨æ˜¯å°†æˆ‘ä»¬è¦ä½¿ç”¨çš„æ¨¡å‹loadåˆ°å„å—å¡ä¸Šï¼ˆç›®å‰å¯¹å•å¡è£…ä¸ä¸‹çš„æ¨¡å‹ï¼ŒvLLMæ”¯æŒtp/ppæ¨ç†ï¼‰ï¼Œç„¶åå¯¹Controllerä¼ æ¥çš„æ•°æ®åš1æ¬¡æ¨ç†ï¼Œè¿”å›ç›¸å…³ç»“æœã€‚æˆ‘ä»¬æ¥ç»†çœ‹ä¸‹è¿™å—ï¼š</p>
<ul>
<li><p><strong>Distributed Workers</strong>ï¼šå›¾ä¸­ç»˜åˆ¶ä¸ºDistributed Workersè¿™ä¸ªç»¿è‰²å—ï¼Œ<strong>å…¶å®æŒ‰vLLMçš„æºç å†…å®¹ï¼Œå†™æˆExecutorä¼šæ›´åˆé€‚ä¸€äº›</strong>ã€‚<strong>å®ƒå°±æ˜¯æ‰€æœ‰Workersçš„ç®¡æ§ä¸­å¿ƒ</strong>ï¼Œå®ƒæŒ‡å®šäº†ç”¨ä»€ä¹ˆæ–¹æ³•ç®¡æ§è¿™äº›Workersï¼Œè´Ÿè´£åˆ†å¸ƒå¼ç¯å¢ƒçš„åˆå§‹åŒ–ï¼Œç›®å‰æ”¯æŒçš„æ–¹æ³•æœ‰ï¼š</p>
</li>
<li><ul>
<li>cpu_executorï¼šï¼ˆè¾ƒå°‘ç”¨ï¼‰ï¼Œä½¿ç”¨cpuåšæ¨ç†æ—¶å¯è€ƒè™‘</li>
<li>gpu_executorï¼šå•å¡ï¼ˆworld_size = 1ï¼‰çš„æƒ…å†µä¸‹å¯ç”¨</li>
<li>ray_gpu_executorï¼šä½¿ç”¨rayè¿™ä¸ªåˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶å®ç°çš„executorï¼Œé€‚ç”¨äºå¤šå¡ç¯å¢ƒ</li>
</ul>
</li>
<li><p><strong>Worker</strong>ï¼š<strong>åœ¨ç¡¬ä»¶ä¸Šï¼Œå®ƒæŒ‡gpuï¼›åœ¨ä»£ç ä¸Šï¼Œå®ƒæŒ‡çš„æ˜¯Workerå®ä¾‹ï¼ˆæ¯ä¸ªgpuä¸Šçš„è¿›ç¨‹ç»´æŠ¤è‡ªå·±çš„Workerå®ä¾‹ï¼‰</strong>ã€‚åœ¨æ¯ä¸ªWorkerå®ä¾‹ä¸­åˆç®¡æ§ç€å¦‚ä¸‹ä¸¤ä¸ªé‡è¦å®ä¾‹ï¼š</p>
</li>
<li><ul>
<li><strong>CacheEngineï¼š</strong>è´Ÿè´£ç®¡æ§gpu/cpuä¸Šçš„KV cacheç‰©ç†å—ï¼ˆè°ƒåº¦å™¨çš„block manageråªè´Ÿè´£ç‰©ç†å—idçš„åˆ†é…ï¼ŒCacheEngineåˆ™æ˜¯æ ¹æ®è¿™ä¸ªidåˆ†é…ç»“æœå®æ‰“å®åœ°åœ¨ç®¡ç†ç‰©ç†å—ä¸­çš„æ•°æ®ï¼‰</li>
<li><strong>Worker.model</strong>ï¼šæ ¹æ®vLLMä»£ç ï¼Œè¿™é‡Œå†™æˆ<strong>model_runner</strong>ä¼šæ›´åˆé€‚ä¸€äº›ã€‚<strong>å®ƒè´Ÿè´£åŠ è½½æ¨¡å‹ï¼Œå¹¶æ‰§è¡Œæ¨ç†</strong>ã€‚PagedAttentionçš„ç›¸å…³é€»è¾‘ï¼Œå°±ç»´æŠ¤è¿™ä¸ªå®ä¾‹å…³è”çš„ä»£ç ä¸‹ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="è¿è¡Œé€»è¾‘"><a href="#è¿è¡Œé€»è¾‘" class="headerlink" title="è¿è¡Œé€»è¾‘"></a>è¿è¡Œé€»è¾‘</h2><blockquote>
<p><strong>åœ¨vLLMæ­£å¼å¼€å§‹å¤„ç†1æ¡è¯·æ±‚ï¼ˆä¹Ÿå°±æ˜¯LLMEngineçš„è°ƒåº¦å™¨æ­£å¼å¼€å§‹è¿ä½œæ—¶ï¼‰ï¼Œå®ƒéœ€è¦åšä¸¤ä»¶å’Œåˆå§‹åŒ–ç›¸å…³çš„äº‹ï¼š</strong></p>
<ul>
<li><strong>åŠ è½½æ¨¡å‹</strong></li>
<li><strong>é¢„åˆ†é…æ˜¾å­˜</strong></li>
</ul>
<ol>
<li>æ¨¡å‹åŠ è½½</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/14" alt="img"></p>
<p>è¿™é‡Œåœ¨åšçš„äº‹å¾ˆç›´è§‚ï¼šæŠŠä½ çš„base modelåŠ è½½åˆ°workerä¸Šã€‚å¦‚æœä½ æ˜¯onlineåŠ è½½çš„ï¼ŒvLLMé»˜è®¤ä½¿ç”¨HuggingFaceï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­æŠŠç›¸å…³é…ç½®æ”¹æˆModelScopeã€‚</p>
<ol start="2">
<li><p>é¢„åˆ†é…æ˜¾å­˜</p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/15" alt="img"></p>
<p><strong>åœ¨æ¨¡å‹éƒ¨ç½²çš„åˆå§‹åŒ–é˜¶æ®µï¼ˆæ¨ç†æ­£å¼å¼€å§‹å‰ï¼‰ï¼ŒvLLMä¼šé€šè¿‡æ¨¡æ‹Ÿå®éªŒçš„æ–¹å¼ï¼Œæ¥å†³å®šgpu/cpuä¸Šåˆ°åº•æœ‰å¤šå°‘ä¸ªKV cacheç‰©ç†å—å¯ä»¥åˆ†é…ç»™åç»­çš„è¯·æ±‚ä»¬åšæ¨ç†ã€‚vLLMç®¡è¿™ä¸ªæ­¥éª¤å«<code>determine_num_available_blocks</code>ï¼Œè·Ÿæ–‡ç« ä¸­çš„ä¸ä¸€æ ·</strong></p>
<p><strong>ï¼ˆ1ï¼‰æœæ’°å‡æ•°æ®</strong></p>
<p><strong>ï¼ˆ2ï¼‰ç”¨å‡æ•°æ®æ¨¡æ‹Ÿä¸€æ¬¡å‰å‘æ¨ç†</strong></p>
<p><strong>æˆ‘ä»¬ç°åœ¨æƒ³çŸ¥é“åœ¨1æ¬¡æ¨ç†è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åˆ†é…å¤šå°‘çš„æ˜¾å­˜ç»™KV cacheã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å…¬å¼è®¡ç®—ï¼š</strong><br><strong>åˆ†é…ç»™KV cacheæ˜¾å­˜ = gpuæ€»æ˜¾å­˜ - ä¸ä½¿ç”¨KV cacheåš1æ¬¡æ¨ç†æ—¶çš„æ˜¾å­˜å ç”¨ï¼ˆåŒ…æ‹¬æ¨¡å‹æœ¬èº«å’Œæ¨ç†è¿‡ç¨‹ä¸­çš„ä¸­é—´æ•°æ®ï¼‰</strong></p>
<p>å¯¹äºâ€œä¸ä½¿ç”¨KV cacheåš1æ¬¡æ¨ç†æ—¶çš„æ˜¾å­˜å ç”¨â€ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æœæ’°å‡ºæ¥çš„å‡æ•°æ®æ¨¡æ‹Ÿä¸€æ¬¡å‰å‘æ¨ç†æ¥è®¡ç®—å¾—å‡ºã€‚åœ¨å‰å‘æ¨ç†ä¹‹åï¼Œæˆ‘ä»¬æŠŠgpuä¸Šçš„ç¼“å­˜æ¸…ä¸€æ¬¡ï¼Œè®©å®ƒä¸è¦å½±å“åç»­æ¨¡å‹çš„æ­£å¸¸æ¨ç†ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰è®¡ç®—å¯åˆ†é…çš„KV cacheç‰©ç†å—æ€»æ•°</strong></p>
<p>CPUä¸Šç‰©ç†å—æ€»æ•°ä¹Ÿæ˜¯åŒç†ï¼Œä½†ä¸GPUä¸åŒçš„æ˜¯ï¼Œå®ƒä¸éœ€è¦åšæ¨¡æ‹Ÿå®éªŒã€‚CPUä¸Šå¯ç”¨çš„å†…å­˜æ€»æ•°æ˜¯ç”¨æˆ·é€šè¿‡å‚æ•°ä¼ è¿›æ¥çš„ï¼ˆé»˜è®¤æ˜¯4Gï¼‰ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬è®¤ä¸ºåªèƒ½åœ¨è¿™4Gçš„ç©ºé—´ä¸Šåšswapã€‚å°†ä¸Šé¢å…¬å¼ä¸­â€œåˆ†é…ç»™KV Cacheçš„æ˜¾å­˜å¤§å°â€æ›¿æ¢æˆ4Gï¼Œå°±èƒ½å¾—åˆ°CPUä¸Šç‰©ç†å—çš„æ•°é‡ã€‚</p>
<p><strong>ï¼ˆ4ï¼‰å°†é¢„åˆ†é…çš„KV CacheåŠ è½½åˆ°gpuä¸Š</strong></p>
<p><strong>å½“æˆ‘ä»¬ç¡®å®šå¥½KV Cache blockçš„å¤§å°åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºempty tensorï¼Œå°†å…¶å…ˆæ”¾ç½®åˆ°gpuä¸Šï¼Œå®ç°æ˜¾å­˜çš„é¢„åˆ†é…ã€‚ä»¥åè¿™å—æ˜¾å­˜å°±æ˜¯ä¸“é—¨ç”¨æ¥åšKV Cacheçš„äº†ã€‚</strong>ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ç§é¢„åˆ†é…ï¼Œä½ å¯èƒ½ä¼šå‘ç°åœ¨vLLMåˆå§‹åŒ–åï¼Œæ˜¾å­˜çš„å ç”¨æ¯”ä½ é¢„æƒ³åœ°è¦å¤šï¼ˆé«˜è¿‡æ¨¡å‹å¤§å°ï¼‰ï¼Œè¿™å°±æ˜¯é¢„åˆ†é…èµ·çš„ä½œç”¨ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼ˆå¸®åŠ©å¤§å®¶æ›´å¥½çœ‹ä¸€ä¸‹KV cache tensorçš„shapeï¼‰:</p>
</li>
</ol>
</blockquote>
<h2 id="Schedulerè°ƒåº¦"><a href="#Schedulerè°ƒåº¦" class="headerlink" title="Schedulerè°ƒåº¦"></a>Schedulerè°ƒåº¦</h2><blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/16" alt="img"></p>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/17" alt="img"></p>
<p><strong>vLLMçš„è°ƒåº¦ç­–ç•¥ä¸­æœ‰ä¸€é¡¹å«åšï¼šåæ¥å…ˆæŠ¢å ï¼ˆ*Preemption*ï¼‰</strong>ã€‚å®ƒæ˜¯æŒ‡åœ¨å‡†å¤‡æ‰§è¡Œå½“å‰è¿™1ä¸ªæ¨ç†é˜¶æ®µæ—¶ï¼Œå¦‚æœgpuä¸Šæ²¡æœ‰è¶³å¤Ÿçš„èµ„æºå¯¹runningé˜Ÿåˆ—ä¸­çš„å…¨éƒ¨æ•°æ®å®Œæˆä¸‹1æ¬¡æ¨ç†ï¼Œæˆ‘ä»¬å°±å–å‡ºrunningé˜Ÿåˆ—ä¸­æœ€åæ¥çš„æ•°æ®ï¼Œå°†å®ƒçš„KV Cache swappedåˆ°CPUä¸Šï¼ŒåŒæ—¶å°†è¿™ä¸ªæ•°æ®ä»runningç§»åˆ°swappedä¸­ã€‚<strong>æˆ‘ä»¬é‡å¤æ‰§è¡Œè¿™ä¸ªæ­¥éª¤ï¼Œç›´åˆ°å½“å‰gpuä¸Šæœ‰è¶³å¤Ÿçš„KV Cacheç©ºé—´ç•™ç»™å‰©åœ¨runningä¸­çš„å…¨éƒ¨æ•°æ®ä¸ºæ­¢ã€‚</strong></p>
</blockquote>
<h2 id="LLMå‡½æ•°"><a href="#LLMå‡½æ•°" class="headerlink" title="LLMå‡½æ•°"></a>LLMå‡½æ•°</h2><blockquote>
<p>å½“æˆ‘ä»¬è°ƒç”¨Â·<code>outputs = llm.generate(prompts, sampling_params)</code>æ—¶ï¼Œ<strong>å®ƒå®é™…åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</strong></p>
<ul>
<li><p><strong><code>_add_request</code><strong>ï¼š</strong>å°†è¾“å…¥æ•°æ®ä¼ ç»™LLMEngine</strong>ï¼Œå®ƒå…·ä½“åšäº†å¦‚ä¸‹äº‹æƒ…ï¼š</p>
</li>
<li><ul>
<li><strong>æŠŠæ¯1ä¸ªpromptåŒ…è£…æˆä¸€ä¸ªSequenceGroupå¯¹è±¡</strong>ã€‚ä»å®¢æˆ·ç«¯è§’åº¦çœ‹ï¼Œ1ä¸ªè¯·æ±‚å¯èƒ½åŒ…å«å¤šä¸ªpromptsï¼Œä¾‹å¦‚ç¦»çº¿æ‰¹å¤„ç†åœºæ™¯ä¸‹ä½ å¯ä»¥å°†1ä¸ªbatchç†è§£æˆ1ä¸ªè¯·æ±‚ï¼›ä½†æ˜¯ä»LLMEngineçš„è§’åº¦çœ‹ï¼Œ1ä¸ªpromptæ˜¯1ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥å®ƒä¼šå¯¹è¾“å…¥æ•°æ®è¿›è¡Œé¢„å¤„ç†ã€‚åœ¨åæ–‡å¯¹SequenceGroupçš„è®²è§£ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¥çœ‹vLLMè¿™æ ·åšçš„æ„ä¹‰ã€‚</li>
<li><strong>æŠŠåŒ…è£…æˆSequenceGroupå¯¹è±¡çš„æ•°æ®åŠ å…¥è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„waitingé˜Ÿåˆ—ï¼Œç­‰å¾…å¤„ç†</strong>ã€‚è¿™ä¸€å—ç›¸å…³çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬æ”¾åœ¨åæ–‡è¯´ã€‚</li>
</ul>
</li>
<li><p><strong><code>_run_engine</code><strong>ï¼š</strong>æ‰§è¡Œæ¨ç†</strong>ã€‚åªè¦è°ƒåº¦å™¨çš„waiting/running/swappedé˜Ÿåˆ—éç©ºï¼Œæˆ‘ä»¬å°±è®¤ä¸ºæ­¤æ—¶è¿™æ‰¹batchè¿˜æ²¡æœ‰åšå®Œæ¨ç†ï¼Œè¿™æ—¶æˆ‘ä»¬å°±ä¼š**è°ƒç”¨LLMEngineçš„step()**å‡½æ•°ï¼Œæ¥å®Œæˆ1æ¬¡è°ƒåº¦ä»¥å†³å®šè¦é€å“ªäº›æ•°æ®å»åšæ¨ç†ã€‚</p>
</li>
</ul>
<p><strong>æ‰€ä»¥ï¼Œæƒ³è¦çŸ¥é“è°ƒåº¦å™¨çš„è¿ä½œæµç¨‹ï¼Œæˆ‘ä»¬åªè¦ä»<code>LLMEngine</code>çš„<code>add_request()</code>å’Œ<code>step()</code>ä¸¤ä¸ªå‡½æ•°å…¥æ‰‹å°±å¥½äº†</strong>ã€‚<strong>ä¸è¿‡åœ¨æ­£å¼è¿›å…¥è¿™ä¸¤ä¸ªå‡½æ•°çš„è®²è§£ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹å’Œè¾“å…¥æ•°æ®ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦æŠŠæ¯ä¸ªpromptéƒ½åŒ…è£…æˆä¸€ä¸ªSequenceGroupå®ä¾‹ï¼ŸSequenceGroupåˆé•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿ</strong></p>
</blockquote>
<h2 id="SequenceGroup"><a href="#SequenceGroup" class="headerlink" title="SequenceGroup"></a>SequenceGroup</h2><blockquote>
<p><strong>å¯èƒ½å‡ºç°â€1ä¸ªprompt -&gt; å¤šä¸ªoutputsâ€çš„æƒ…å†µã€‚é‚£æ˜¯å¦èƒ½è®¾è®¡ä¸€ç§åŠæ³•ï¼Œå¯¹1ä¸ªpromptä¸‹æ‰€æœ‰çš„outputsè¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œæ¥æ–¹ä¾¿vLLMæ›´å¥½åšæ¨ç†å‘¢ï¼Ÿ</strong></p>
</blockquote>
<blockquote>
<h3 id="SequenceGroupçš„ä½œç”¨"><a href="#SequenceGroupçš„ä½œç”¨" class="headerlink" title="SequenceGroupçš„ä½œç”¨"></a>SequenceGroupçš„ä½œç”¨</h3><ul>
<li><p><strong>â€œ1ä¸ªprompt -&gt; å¤šä¸ªoutputsâ€è¿™æ ·çš„ç»“æ„ç»„æˆä¸€ä¸ª<code>SequenceGroup</code>å®ä¾‹ã€‚</strong></p>
</li>
<li><p><strong>å…¶ä¸­æ¯ç»„â€prompt -&gt; outputâ€ç»„æˆä¸€ä¸ªåºåˆ—ï¼ˆseqï¼Œå±äº<code>Sequence</code>å®ä¾‹ï¼‰ï¼Œæ¯ä¸ªseqä¸‹æœ‰è‹¥å¹²çŠ¶æ€(status)å±æ€§ï¼ŒåŒ…æ‹¬ï¼š</strong></p>
</li>
<li><ul>
<li><p><strong><code>WAITING</code>ï¼š</strong>æ­£åœ¨waitingé˜Ÿåˆ—ä¸­ã€‚waitingé˜Ÿåˆ—ä¸­çš„åºåˆ—éƒ½æ²¡æœ‰åšè¿‡prefillã€‚</p>
</li>
<li><p><strong><code>RUNNING</code>ï¼š</strong>æ­£åœ¨runningé˜Ÿåˆ—ä¸­ï¼Œå³å·²ç»å¼€å§‹åšæ¨ç†ã€‚</p>
</li>
<li><p><strong><code>SWAPPED</code>ï¼š</strong>æ­£åœ¨swappedé˜Ÿåˆ—ä¸­ï¼Œè¡¨ç¤ºæ­¤æ—¶gpuèµ„æºä¸è¶³ï¼Œç›¸å…³çš„seq_groupè¢«æŠ¢å ï¼Œå¯¼è‡´å…¶æš‚åœæ¨ç†ï¼Œç›¸å…³çš„KV blockè¢«ç½®æ¢åˆ°cpuä¸Šï¼ˆswap outï¼‰ï¼Œç­‰å¾…gpuèµ„æºå……è¶³æ—¶å†ç½®æ¢å›æ¥é‡æ–°è®¡ç®—ï¼ˆswap inï¼‰ã€‚</p>
</li>
<li><p><strong>è‹¥å¹²å’ŒFinishç›¸å…³çš„çŠ¶æ€</strong>ï¼Œè¡¨ç¤ºè¯¥seqæ¨ç†å·²ç»ç»“æŸï¼Œå…·ä½“åŒ…æ‹¬ï¼š</p>
</li>
<li><ul>
<li><strong><code>FINISHED_STOPPED</code>ï¼š</strong>æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼Œä¾‹å¦‚ç¢°åˆ°<code>&lt;eos&gt;</code>ç¬¦å·ï¼Œè¯¥seqçš„æ¨ç†æ­£å¸¸ç»“æŸäº†</li>
<li>**<code>FINISHED_LENGTH_CAPPED</code>**ï¼šå› ä¸ºseqçš„é•¿åº¦è¾¾åˆ°æœ€å¤§é•¿åº¦é™åˆ¶ï¼Œè€Œç»“æŸæ¨ç†</li>
<li>**<code>FINISHED_ABORTED</code>**ï¼šå› ä¸æ­£å¸¸çŠ¶æ€ï¼Œè€Œè¢«ç»ˆæ­¢çš„æ¨ç†ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œåˆ™æœåŠ¡å™¨ä¼šç»ˆæ­¢ç›¸å…³seqçš„æ¨ç†</li>
<li>**<code>FINISHED_IGNORED</code>**ï¼šå› promptè¿‡é•¿è€Œè¢«ç»ˆæ­¢æ‰§è¡Œçš„æ¨ç†ã€‚æœ¬è´¨ä¸Šä¹Ÿæ˜¯å—åˆ°é•¿åº¦é™åˆ¶</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>åœ¨vLLMä¸­æœ‰ä¸€ä¸ªé‡è¦å‡è®¾ï¼šä¸€ä¸ªseq_groupä¸­çš„æ‰€æœ‰seqå…±äº«1ä¸ªpromptã€‚</strong></p>
</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<ul>
<li><p><strong>åœ¨æ¨ç†å¼€å§‹ä¹‹å‰</strong>ï¼Œè¿™ä¸ªseq_groupä¸‹åªæœ‰1æ¡seqï¼Œå®ƒå°±æ˜¯promptï¼ŒçŠ¶æ€ä¸ºwaitingã€‚</p>
</li>
<li><p><strong>åœ¨ç¬¬1ä¸ªæ¨ç†é˜¶æ®µ</strong>ï¼Œè°ƒåº¦å™¨é€‰ä¸­äº†è¿™ä¸ªseq_groupï¼Œç”±äºå®ƒçš„é‡‡æ ·å‚æ•°ä¸­<code>n = 4</code>ï¼Œæ‰€ä»¥åœ¨åšå®Œprefillä¹‹åï¼Œå®ƒä¼šç”Ÿæˆ4ä¸ªseqï¼Œå®ƒä»¬çš„çŠ¶æ€éƒ½æ˜¯runningã€‚</p>
</li>
<li><p><strong>åœ¨è‹¥å¹²ä¸ªæ¨ç†é˜¶æ®µåï¼Œgpuä¸Šçš„èµ„æºä¸å¤Ÿäº†ï¼Œè¿™ä¸ªseq_groupä¸å¹¸è¢«è°ƒåº¦å™¨æŠ¢å ï¼ˆpreemptionï¼‰</strong>ï¼Œå®ƒç›¸å…³çš„KV blockä¹Ÿè¢«swap outåˆ°cpuä¸Šã€‚æ­¤æ—¶æ‰€æœ‰seqçš„çŠ¶æ€å˜ä¸ºswappedã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œ<strong>å½“ä¸€ä¸ªseq_groupè¢«æŠ¢å æ—¶ï¼Œå¯¹å®ƒçš„å¤„ç†æœ‰ä¸¤ç§æ–¹å¼ï¼š</strong></p>
</li>
<li><ul>
<li><strong>Swapï¼šå¦‚æœè¯¥seq_groupä¸‹çš„seqæ•°é‡ &gt; 1ï¼Œæ­¤æ—¶ä¼šé‡‡å–swapç­–ç•¥</strong>ï¼Œå³æŠŠseq_groupä¸‹ã€æ‰€æœ‰ã€‘seqçš„KV blockä»gpuä¸Šå¸è½½åˆ°cpuä¸Šã€‚ï¼ˆseqæ•°é‡æ¯”è¾ƒå¤šï¼Œç›´æ¥æŠŠç®—å‡ºçš„KV blockæŠ›å¼ƒï¼Œæ¯”è¾ƒå¯æƒœï¼‰</li>
<li><strong>Recomputationï¼šå¦‚æœè¯¥seq_groupä¸‹çš„seqæ•°é‡ = 1ï¼Œæ­¤æ—¶ä¼šé‡‡å–recomputationç­–ç•¥</strong>ï¼Œå³æŠŠè¯¥seq_groupç›¸å…³çš„ç‰©ç†å—éƒ½é‡Šæ”¾æ‰ï¼Œç„¶åå°†å®ƒé‡æ–°æ”¾å›waitingé˜Ÿåˆ—ä¸­ã€‚ç­‰ä¸‹æ¬¡å®ƒè¢«é€‰ä¸­æ¨ç†æ—¶ï¼Œå°±æ˜¯ä»prefillé˜¶æ®µå¼€å§‹é‡æ–°æ¨ç†äº†ï¼Œå› æ­¤è¢«ç§°ä¸ºâ€œé‡è®¡ç®—â€ã€‚ï¼ˆseqæ•°é‡å°‘ï¼Œé‡æ–°è®¡ç®—KV blockçš„æˆæœ¬ä¸é«˜ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>ã€æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªseq_groupéƒ½ä¼šç»å†æŠ¢å ï¼Œå…·ä½“è¦çœ‹è°ƒåº¦å™¨ç­–ç•¥å’Œgpuèµ„æºä½¿ç”¨æƒ…å†µã€‘</strong></p>
<ul>
<li><strong>åˆè¿‡äº†è‹¥å¹²ä¸ªæ¨ç†é˜¶æ®µï¼Œgpuä¸Šçš„èµ„æºåˆå……è¶³äº†ï¼Œæ­¤æ—¶æ‰§è¡Œswap inæ“ä½œ</strong>ï¼Œå°†å¸è½½åˆ°cpuä¸Šçš„KV blocké‡æ–°è¯»åˆ°gpuä¸Šï¼Œç»§ç»­å¯¹è¯¥seq_groupåšæ¨ç†ï¼Œæ­¤æ—¶seqçš„çŠ¶æ€åˆå˜ä¸ºrunningã€‚</li>
<li><strong>åˆè¿‡äº†è‹¥å¹²ä¸ªæ¨ç†é˜¶æ®µï¼Œè¯¥seq_groupä¸­æœ‰1ä¸ªseqå·²ç»æ¨ç†å®Œæˆäº†ï¼Œå®ƒçš„çŠ¶æ€å°±è¢«æ ‡è®°ä¸ºfinish</strong>ï¼Œæ­¤åè¿™æ¡å·²ç»å®Œæˆçš„seqå°†ä¸å‚ä¸è°ƒåº¦ã€‚</li>
<li><strong>åˆè¿‡äº†è‹¥å¹²ä¸ªæ¨ç†é˜¶æ®µï¼Œè¿™ä¸ªseq_groupä¸‹æ‰€æœ‰çš„seqéƒ½å·²ç»å®Œæˆæ¨ç†äº†</strong>ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠå®ƒä½œä¸ºæœ€ç»ˆoutputè¿”å›äº†ã€‚</li>
</ul>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/18" alt="img"></p>
</blockquote>
<blockquote>
<p><strong>SequenceGroup:</strong></p>
<ul>
<li>**<code>self.seqs_dict</code>**ï¼š{seq_id: seq}ï¼Œå…¶ä¸­æ¯ä¸ªseqæ˜¯ä¸€ä¸ªSequenceå¯¹è±¡ã€‚æ­£å¦‚æˆ‘ä»¬å‰æ–‡ä»‹ç»çš„é‚£æ ·ï¼Œä¸€ä¸ªseq_groupä¸‹åŒ…å«è‹¥å¹²seqs</li>
<li>**<code>self.sampling_params</code>**ï¼šé‡‡æ ·å‚æ•°</li>
<li><strong><code>self.metrics</code><strong>ï¼š</strong>è®°å½•è¯¥seq_groupç›¸å…³çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚è¯¥seq_groupæ˜¯ä»€ä¹ˆæ—¶å€™è¢«åŠ å…¥LLMEngineçš„ï¼ˆarrival_timeï¼‰</strong>ï¼Œè¯¥seq_groupç¬¬ä¸€æ¬¡è¢«è°ƒåº¦å™¨é€‰ä¸­è°ƒåº¦æ˜¯ä»€ä¹ˆæ—¶å€™ç­‰ç­‰ã€‚è°ƒåº¦å™¨åœ¨é€‰æ‹©æ—¶ï¼Œä¼šå‚è€ƒseq_groupsä»¬çš„è¿™äº›æŒ‡æ ‡æ¥åšå†³ç­–ã€‚</li>
<li><strong><code>get_max_num_running_steps</code><strong>ï¼š</strong>è¯¥seq_groupåœ¨å‰©ä½™ç”Ÿå‘½å‘¨æœŸå†…å¹¶è¡Œrunningçš„æœ€å¤§seqæ•°é‡</strong>ã€‚<strong>â€œå‰©ä½™ç”Ÿå‘½å‘¨æœŸâ€æŒ‡ä»æ­¤åˆ»ä¸€ç›´åˆ°seq_groupä¸­æ‰€æœ‰çš„seqéƒ½åšå®Œæ¨ç†</strong>ã€‚ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œæˆ‘ä»¬çœ‹2.2èŠ‚é…å›¾ä¸­å€’æ•°ç¬¬3ä¸ªæ—¶åˆ»ï¼Œæ­¤æ—¶è¿™ä¸ªseq_groupå†…æ‰€æœ‰çš„seqéƒ½è¿˜æ²¡ç»“æŸæ¨ç†ï¼Œæ‰€ä»¥è‹¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™è¿”å›å€¼ä¸º4ï¼›å†çœ‹å€’æ•°ç¬¬2ä¸ªæ—¶åˆ»ï¼Œæ­¤æ—¶æœ‰1ä¸ªseqå·²ç»å®Œæˆäº†æ¨ç†ï¼Œæ‰€ä»¥è‹¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™è¿”å›å€¼ä¸º3ã€‚åœ¨åç»­è°ƒåº¦ç­–ç•¥ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†ç»å¸¸çœ‹åˆ°è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œç›®çš„æ˜¯ç”¨äºä¼°è®¡è‹¥å½“å‰å¯¹ä¸€ä¸ªseq_groupåšæ¨ç†ï¼Œå®ƒå°†æ¶ˆè€—å¤šå°‘gpuèµ„æºã€‚</li>
</ul>
</blockquote>
<blockquote>
<p>Sequence:</p>
<p>å¯¹äºä¸€ä¸ªseqï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹å®ƒçš„å±æ€§<code>self.logical_token_blocks</code>ï¼ˆé€»è¾‘å—ï¼‰å’Œæ–¹æ³•<code>_append_tokens_to_blocks</code>ï¼ˆç”Ÿæˆé€»è¾‘å—çš„æ–¹æ³•ï¼‰ã€‚<strong>åœ¨vLLMä¸­ï¼Œæ¯ä¸ªseqéƒ½å•ç‹¬ç»´æŠ¤ä¸€ä»½å±äºè‡ªå·±çš„é€»è¾‘å—ï¼Œä¸åŒçš„é€»è¾‘å—å¯ä»¥æŒ‡å‘åŒä¸€ä¸ªç‰©ç†å—</strong>ï¼ˆæ­¤åˆ»ä½ ä¸€å®šå¾ˆå…³å¿ƒé€»è¾‘å—å’Œç‰©ç†å—æ˜¯å¦‚ä½•åšæ˜ å°„çš„ï¼Œæˆ‘ä»¬ä¼šå¾ªåºæ¸è¿›åœ°è®²è§£è¿™ç‚¹ï¼Œ<strong>ç°åœ¨ä½ å¯ä»¥å…ˆå¿½ç•¥æ˜ å°„æ–¹æ³•ï¼ŒæŠŠç›®å…‰èšç„¦äºâ€œä¸€ä¸ªseqçš„é€»è¾‘å—é•¿ä»€ä¹ˆæ ·ï¼Œæ€ä¹ˆåˆå§‹åŒ–å®ƒçš„é€»è¾‘å—â€</strong>ï¼‰</p>
<p>åˆ†é… _append_tokens_to_blocks</p>
</blockquote>
<h2 id="add-request"><a href="#add-request" class="headerlink" title="add_request()"></a>add_request()</h2><blockquote>
<p> å°†seq_groupæ·»åŠ è¿›è°ƒåº¦å™¨waitingé˜Ÿåˆ—</p>
</blockquote>
<h2 id="step"><a href="#step" class="headerlink" title="step()"></a>step()</h2><p><strong>è°ƒåº¦å™¨ç»“æ„</strong></p>
<blockquote>
<p><img lazyload="" src="/images/loading.svg" data-src="/images/llm-4/19" alt="img"></p>
<ul>
<li><p>**<code>self.waiting, self.running, self.swapped</code>**ï¼šè¿™ä¸‰ä¸ªéƒ½æ˜¯pythonçš„deque()å®ä¾‹ï¼ˆåŒç«¯é˜Ÿåˆ—ï¼Œå…è®¸ä½ ä»é˜Ÿåˆ—ä¸¤ä¾§æ·»åŠ æˆ–åˆ é™¤å…ƒç´ ï¼‰ã€‚</p>
</li>
<li><ul>
<li><strong>waitingé˜Ÿåˆ—ç”¨äºå­˜æ”¾æ‰€æœ‰è¿˜æœªå¼€å§‹åšæ¨ç†çš„seq_group</strong>ï¼Œâ€œæœªå¼€å§‹â€æŒ‡è¿prefillé˜¶æ®µéƒ½æ²¡æœ‰ç»å†è¿‡ã€‚æ‰€ä»¥waitingé˜Ÿåˆ—ä¸­çš„seq_groupåªæœ‰ä¸€ä¸ªseqï¼Œå³æ˜¯åŸå§‹çš„promptã€‚</li>
<li><strong>runningé˜Ÿåˆ—ç”¨äºå­˜æ”¾å½“å‰æ­£åœ¨åšæ¨ç†çš„seq_groupã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒå­˜æ”¾çš„æ˜¯ä¸Š1ä¸ªæ¨ç†é˜¶æ®µè¢«é€å»åšæ¨ç†çš„seq_groupä»¬</strong>ï¼Œåœ¨å¼€å§‹æ–°ä¸€è½®æ¨ç†é˜¶æ®µæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®æœ¬è½®çš„ç­›é€‰ç»“æœï¼Œæ›´æ–°runningé˜Ÿåˆ—ï¼Œå³å†³å®šæœ¬è½®è¦é€å“ªäº›seq_groupå»åšæ¨ç†ã€‚</li>
<li><strong>swappedé˜Ÿåˆ—ç”¨äºå­˜æ”¾è¢«æŠ¢å çš„seq_group</strong>ã€‚åœ¨2.2èŠ‚ä¸­æˆ‘ä»¬æœ‰æè¿‡ï¼Œè‹¥ä¸€ä¸ªseq_groupè¢«æŠ¢å ï¼Œè°ƒåº¦å™¨ä¼šå¯¹å®ƒæ‰§è¡Œswapæˆ–recomputationæ“ä½œï¼Œåˆ†åˆ«å¯¹åº”ç€å°†å®ƒé€å»swappedé˜Ÿåˆ—æˆ–waitingé˜Ÿåˆ—ï¼Œåœ¨åæ–‡æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†ææŠ¢å å¤„ç†çš„ä»£ç </li>
</ul>
</li>
<li><p><strong><code>self.policy</code>ï¼šæ˜¯vLLMè‡ªå®šä¹‰çš„ä¸€ä¸ªPolicyå®ä¾‹ï¼Œ</strong>ç›®æ ‡æ˜¯æ ¹æ®è°ƒåº¦å™¨æ€»ç­–ç•¥ï¼ˆ<strong>FCFS</strong>ï¼ŒFirst Come First Serveï¼Œå…ˆæ¥å…ˆæœåŠ¡ï¼‰åŸåˆ™ï¼Œ<strong>å¯¹å„ä¸ªé˜Ÿåˆ—é‡Œçš„seq_groupæŒ‰ç…§å…¶arrival timeè¿›è¡Œæ’åº</strong>ã€‚ç›¸å…³ä»£ç æ¯”è¾ƒå¥½è¯»ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªæ¦‚è¿°å®ƒçš„ä½œç”¨ï¼Œåç»­ä¸å†ä»‹ç»å®ƒçš„ä»£ç å®ç°ã€‚</p>
</li>
<li><p><strong><code>self.prev_time</code><strong>ï¼š</strong>ä¸Šä¸€æ¬¡è°ƒåº¦å‘èµ·çš„æ—¶é—´ç‚¹ï¼Œåˆå§‹åŒ–ä¸º0ã€‚</strong>æˆ‘ä»¬çŸ¥é“æ¯æ‰§è¡Œ1æ¬¡æ¨ç†é˜¶æ®µå‰ï¼Œè°ƒåº¦å™¨éƒ½è¦åšä¸€æ¬¡è°ƒåº¦ï¼Œè¿™ä¸ªå˜é‡å­˜æ”¾çš„å°±æ˜¯ä¸Šæ¬¡è°ƒåº¦å‘èµ·çš„æ—¶é—´ç‚¹ã€‚</p>
</li>
<li><p><strong><code>self.prev_prompt</code><strong>ï¼šå–å€¼ä¸ºTrue/Falseï¼Œåˆå§‹åŒ–ä¸ºFalseã€‚</strong>è‹¥ä¸Šä¸€æ¬¡è°ƒåº¦æ—¶ï¼Œè°ƒåº¦å™¨æœ‰ä»waitingé˜Ÿåˆ—ä¸­å–å‡ºseq_groupåšæ¨ç†ï¼Œå³ä¸ºTrueï¼Œå¦åˆ™ä¸ºFalseã€‚</strong></p>
</li>
<li><p><strong><code>self.last_prompt_latency</code><strong>ï¼š</strong>è®°å½•â€œå½“å‰è°ƒåº¦æ—¶åˆ»ï¼ˆnowï¼‰ - æœ€åä¸€æ¬¡æœ‰ä»waitingé˜Ÿåˆ—ä¸­å–æ•°åšæ¨ç†çš„é‚£ä¸ªè°ƒåº¦æ—¶åˆ»â€çš„å·®å€¼</strong>ï¼ˆå¹¶ä¸æ˜¯æ¯ä¸€æ¬¡è°ƒåº¦æ—¶ï¼Œè°ƒåº¦å™¨ä¸€å®šéƒ½ä¼šä»waitingé˜Ÿåˆ—ä¸­å–seq_groupï¼Œå®ƒå¯èƒ½ä¾æ—§ç»§ç»­å¯¹runningé˜Ÿåˆ—ä¸­çš„æ•°æ®åšæ¨ç†ï¼‰ï¼Œåˆå§‹åŒ–ä¸º0ã€‚</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p><strong><code>BlockManager</code><strong>ï¼š</strong>ç‰©ç†å—ç®¡ç†å™¨</strong>ã€‚è¿™ä¹Ÿæ˜¯vLLMè‡ªå®šä¹‰çš„ä¸€ä¸ªclassã€‚æˆªæ­¢æœ¬æ–‡å†™ä½œæ—¶ï¼ŒvLLMæä¾›äº†<code>BlockSpaceManagerV1</code>å’Œ<code>BlockSpaceManagerV2</code>ä¸¤ä¸ªç‰ˆæœ¬çš„å—ç®¡ç†å™¨ã€‚V1æ˜¯vLLMé»˜è®¤çš„ç‰ˆæœ¬ï¼ŒV2æ˜¯æ”¹è¿›ç‰ˆæœ¬ï¼ˆä½†è¿˜æ²¡å¼€å‘å®Œï¼Œä¾‹å¦‚ä¸æ”¯æŒprefix cachingç­‰åŠŸèƒ½ï¼‰ã€‚æ‰€ä»¥æœ¬æ–‡ä¾ç„¶åŸºäº<code>BlockSpaceManagerV1</code>è¿›è¡Œè®²è§£ã€‚ç‰©ç†å—ç®¡ç†å™¨è¿™ä¸ªclassä¸‹åˆç»´æŠ¤ç€ä¸¤ä¸ªé‡è¦å±æ€§ï¼š</p>
</li>
<li><ul>
<li><strong><code>BlockAllocator</code>ï¼šç‰©ç†å—åˆ†é…è€…ï¼Œè´Ÿè´£å®é™…ä¸ºseqåšç‰©ç†å—çš„åˆ†é…ã€é‡Šæ”¾ã€æ‹·è´ç­‰æ“ä½œã€‚</strong>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åæ–‡è¦è§£è¯»çš„å¯¹è±¡ã€‚å…¶ä¸‹åˆåˆ†æˆ<code>self.gpu_allocator</code>å’Œ<code>self.cpu_allocator</code>ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«ç®¡ç†gpuå’Œcpuä¸Šçš„ç‰©ç†å—ã€‚</li>
<li><strong><code>self.block_tables</code>ï¼šè´Ÿè´£ç»´æŠ¤æ¯ä¸ªseqä¸‹çš„ç‰©ç†å—åˆ—è¡¨ï¼Œæœ¬è´¨ä¸Šå®ƒæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå½¢å¼å¦‚<code>{seq_id: List[PhysicalTokenBlock]}</code>ã€‚</strong>æ³¨æ„ï¼Œè¿™é‡Œç»´æŠ¤è€…ã€æ‰€æœ‰ã€‘seq_groupä¸‹seqçš„ç‰©ç†å—ï¼Œè€Œä¸æ˜¯å•ç‹¬æŸä¸€ä¸ªseqçš„ã€‚å› ä¸ºæ•´ä¸ªè°ƒåº¦å™¨éƒ½æ˜¯å…¨å±€çš„ï¼Œå…¶ä¸‹çš„BlockManagerè‡ªç„¶ä¹Ÿæ˜¯å…¨å±€çš„ã€‚</li>
</ul>
</li>
<li><p><strong>BlockManageråªè´Ÿè´£ç®¡ç†å’Œåˆ†é…ç‰©ç†å—ï¼Œæ˜ å°„å…³ç³»æ½œè—åœ¨seqä¸­</strong>ã€‚ç†è§£è¿™ç‚¹å¯¹ç†è§£ä»£ç éå¸¸é‡è¦ã€‚</p>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p><strong>å¦‚æœå½“å‰swappedé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£å°±å»æ£€æŸ¥æ˜¯å¦èƒ½ä»waitingé˜Ÿåˆ—ä¸­è°ƒåº¦seq_groupï¼Œç›´åˆ°ä¸æ»¡è¶³è°ƒåº¦æ¡ä»¶ä¸ºæ­¢ï¼ˆgpuç©ºé—´ä¸è¶³ï¼Œæˆ–waitingé˜Ÿåˆ—å·²ä¸ºç©ºç­‰ï¼‰</strong>ã€‚<strong>æ­¤æ—¶ï¼Œ1ä¸ªæ¨ç†é˜¶æ®µä¸­ï¼Œæ‰€æœ‰çš„seq_groupéƒ½å¤„åœ¨prefillé˜¶æ®µã€‚</strong></p>
</li>
<li><p><strong>å¦‚æœå½“å‰swappedé˜Ÿåˆ—éç©ºï¼Œæˆ–è€…æ— æ³•ä»waitingé˜Ÿåˆ—ä¸­è°ƒåº¦ä»»ä½•seq_groupæ—¶ï¼š</strong></p>
</li>
<li><ul>
<li>æ£€æŸ¥æ˜¯å¦èƒ½ä»runningé˜Ÿåˆ—ä¸­è°ƒåº¦seq_groupï¼Œç›´åˆ°ä¸æ»¡è¶³è°ƒåº¦æ¡ä»¶ä¸ºæ­¢ã€‚</li>
<li>è‹¥æœ¬æ¬¡æ— æ–°çš„è¢«æŠ¢å çš„seq_groupï¼Œä¸”swappedé˜Ÿåˆ—éç©ºï¼Œå°±æ£€æŸ¥æ˜¯å¦èƒ½ä»swappedé˜Ÿåˆ—ä¸­è°ƒåº¦seq_groupï¼Œç›´åˆ°ä¸æ»¡è¶³è°ƒåº¦æ¡ä»¶ä¸ºæ­¢ã€‚</li>
</ul>
</li>
</ul>
<p><strong>æ­¤æ—¶ï¼Œ1ä¸ªæ¨ç†é˜¶æ®µä¸­ï¼Œæ‰€æœ‰çš„seq_groupè¦ä¹ˆå…¨æ¥è‡ªrunningé˜Ÿåˆ—ï¼Œè¦ä¹ˆæ¥è‡ªrunning + swappedé˜Ÿåˆ—ï¼Œå®ƒä»¬éƒ½å¤„åœ¨decodeé˜¶æ®µã€‚</strong></p>
<p><strong>è‡³æ­¤æˆ‘ä»¬è¦è®°ä½vLLMè°ƒåº¦ä¸­éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼šåœ¨1ä¸ªæ¨ç†é˜¶æ®µä¸­ï¼Œæ‰€æœ‰çš„seq_groupè¦ä¹ˆå…¨éƒ¨å¤„åœ¨prefillé˜¶æ®µã€‚è¦ä¹ˆå…¨éƒ¨å¤„åœ¨decodeé˜¶æ®µã€‚</strong></p>
<p>ä½ å¯èƒ½æƒ³é—®ï¼š<strong>ä¸ºä»€ä¹ˆè¦ä»¥swappedæ˜¯å¦éç©ºä¸ºåˆ¤æ–­å…¥å£å‘¢ï¼Ÿ</strong><br>è¿™æ˜¯å› ä¸ºï¼Œå¦‚æœå½“å‰è°ƒåº¦æ­¥éª¤ä¸­swappedé˜Ÿåˆ—éç©ºï¼Œè¯´æ˜åœ¨ä¹‹å‰çš„è°ƒåº¦æ­¥éª¤ä¸­è¿™äº›å¯æ€œçš„seq_groupå› ä¸ºèµ„æºä¸è¶³è¢«æŠ¢å ï¼Œè€Œåœæ»äº†æ¨ç†ã€‚æ‰€ä»¥<strong>æ ¹æ®FCFSè§„åˆ™ï¼Œå½“gpuä¸Šæœ‰å……è¶³èµ„æºæ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆè€ƒè™‘å®ƒä»¬ï¼Œè€Œä¸æ˜¯è€ƒè™‘waitingé˜Ÿåˆ—ä¸­æ–°æ¥çš„é‚£äº›seq_groupã€‚</strong><br>åŒç†ï¼Œåœ¨å›¾ä¸­ä½ ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬è¿›å…¥å¯¹runningé˜Ÿåˆ—çš„è°ƒåº¦æ—¶ï¼ˆå›¾ä¸­çº¢è‰²åˆ†æ”¯ï¼‰ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®â€œ<strong>æœ¬æ¬¡è°ƒåº¦æ˜¯å¦æœ‰æ–°çš„è¢«æŠ¢å çš„seq_group</strong>â€ï¼Œæ¥å†³å®šè¦ä¸è¦è°ƒåº¦swappedé˜Ÿåˆ—ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªç†ç”±ä¹Ÿå¾ˆç®€å•ï¼šåœ¨æœ¬æ¬¡è°ƒåº¦ä¸­ï¼Œæˆ‘å°±æ˜¯å› ä¸ºè€ƒè™‘åˆ°gpuç©ºé—´ä¸è¶³çš„é£é™©ï¼Œæˆ‘æ‰æ–°æŠ¢å äº†ä¸€æ‰¹åºåˆ—ã€‚æ—¢ç„¶å­˜åœ¨è¿™ä¸ªé£é™©ï¼Œæˆ‘å°±æœ€å¥½ä¸è¦å†å»å·²æœ‰çš„swappedé˜Ÿåˆ—ä¸­ç»§ç»­è°ƒåº¦seq_groupäº†ã€‚</p>
</blockquote>
<h2 id="passed-delay"><a href="#passed-delay" class="headerlink" title="_passed_delay()"></a>_passed_delay()</h2><p>åˆ¤æ–­è°ƒåº¦waitingé˜Ÿåˆ—çš„æ—¶é—´ç‚¹</p>
<h2 id="can-allocate"><a href="#can-allocate" class="headerlink" title="can_allocate()"></a>can_allocate()</h2>
        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Artificial-Intelligence/">#Artificial Intelligence</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                        rel="prev"
                        href="/2024/04/01/hpc-ai-1/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Orca, A Distributed Serving System for Transformer-Based Generative Models</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                        rel="next"
                        href="/2024/03/29/nlp-6/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">ã€å­¦ä¹ ç¬”è®°ã€‘è‡ªå›å½’æ¨¡å‹å’ŒGPT</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">ã€å­¦ä¹ ç¬”è®°ã€‘vLLM</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="nav-text">é¢„å¤‡çŸ¥è¯†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#transformer%E7%9A%84self-attention-layers"><span class="nav-text">transformerçš„self-attention layers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KV-Cache"><span class="nav-text">KV Cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%93%E5%89%8DBatching-Techniques-for-LLMs"><span class="nav-text">å½“å‰Batching Techniques for LLMs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory-Challenges-in-LLM-Serving"><span class="nav-text">Memory Challenges in LLM Serving</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vLLM"><span class="nav-text">vLLM</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E6%9E%9C"><span class="nav-text">æ•ˆæœ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PagedAttention"><span class="nav-text">PagedAttention</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scheduling-and-Preemption"><span class="nav-text">Scheduling and Preemption</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Distributed-Execution"><span class="nav-text">Distributed Execution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="nav-text">æºç è§£è¯»</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E4%BB%A3%E7%A0%81%E6%9E%B6%E6%9E%84"><span class="nav-text">æ•´ä½“ä»£ç æ¶æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Centralized-Controller"><span class="nav-text">Centralized Controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Distributed-Workers"><span class="nav-text">Distributed Workers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E9%80%BB%E8%BE%91"><span class="nav-text">è¿è¡Œé€»è¾‘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scheduler%E8%B0%83%E5%BA%A6"><span class="nav-text">Schedulerè°ƒåº¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LLM%E5%87%BD%E6%95%B0"><span class="nav-text">LLMå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SequenceGroup"><span class="nav-text">SequenceGroup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SequenceGroup%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">SequenceGroupçš„ä½œç”¨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#add-request"><span class="nav-text">add_request()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step"><span class="nav-text">step()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#passed-delay"><span class="nav-text">_passed_delay()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#can-allocate"><span class="nav-text">can_allocate()</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Julian</a>
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.4.4</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
            
                
        
                
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex justify-center items-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
        ],
        containers: ["#swup"],
    });

    swup.hooks.on("page:view", () => {
        Global.refresh();
    });

    // if (document.readyState === "complete") {
    //
    // } else {
    //     document.addEventListener("DOMContentLoaded", () => init());
    // }
</script>






<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/libs/anime.min.js"></script>

        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
